name: CDK Deployment Pipeline

on:
  push:
    branches:
      - dev        # Deploy to dev environment
      - main  # Deploy to main environment
      - dr          # Deploy to DR environment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
          - dr

env:
  NODE_VERSION: '16'

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - id: set-env
        run: |
          if [ "${{ github.event.inputs.environment }}" != "" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/dr" ]; then
            echo "environment=dr" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
  
  deploy:
    needs: determine-environment
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          PROD_DB_USERNAME=${{ secrets.PROD_DB_USERNAME }}
          PROD_DB_PASSWORD=${{ secrets.PROD_DB_PASSWORD }}
          PROD_GRAFANA_ADMIN_PASSWORD=${{ secrets.PROD_GRAFANA_ADMIN_PASSWORD }}
          DR_DB_USERNAME=${{ secrets.DR_DB_USERNAME }}
          DR_DB_PASSWORD=${{ secrets.DR_DB_PASSWORD }}
          DR_GRAFANA_ADMIN_PASSWORD=${{ secrets.DR_GRAFANA_ADMIN_PASSWORD }}
          EOF
      
      - name: Synth CDK stack
        run: npm run cdk synth
        
      - name: Deploy CDK stack
        run: |
          if [ "${{ needs.determine-environment.outputs.environment }}" == "dev" ]; then
            npm run cdk deploy EcsJenkinsGithubDevStack -- --require-approval never
          elif [ "${{ needs.determine-environment.outputs.environment }}" == "prod" ]; then
            npm run cdk deploy EcsJenkinsGithubProdStack -- --require-approval never
          elif [ "${{ needs.determine-environment.outputs.environment }}" == "dr" ]; then
            npm run cdk deploy EcsJenkinsGithubDrStack -- --require-approval never
          fi

  sync-dr-with-prod:
    needs: [determine-environment, deploy]
    runs-on: ubuntu-latest
    if: needs.determine-environment.outputs.environment == 'prod'
    steps:
      - name: Setup DR sync
        run: |
          echo "Setting up DR synchronization after main deployment"
          # This step would include logic to synchronize data from main to DR
          # For example:
          # - Database backups and restores
          # - S3 bucket synchronization
          # - Configuration file synchronization
          
          # Placeholder for actual DR sync script
          echo "DR synchronization complete"